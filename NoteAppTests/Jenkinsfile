pipeline {
    agent any

    environment {
        APP_REPO = "https://github.com/SadiaImran/NoteApplication.git"
        TEST_DIR = "/var/lib/jenkins/NoteApplication/NoteAppTests"
    }

    stages {
        stage('Clean workspace') {
            steps {
                sh '''
                rm -rf $TEST_DIR
                mkdir -p $TEST_DIR
                '''
            }
        }

        stage('Clone Repo') {
            steps {
                sh "git clone $APP_REPO $TEST_DIR"
            }
        }

        stage('Run Tests') {
            steps {
                dir("$TEST_DIR") {
                    sh '''
                    docker build -t noteapp-tests .
                    docker run --rm noteapp-tests > test_output.txt || true
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                // Get latest Git commit author's email
                def authorEmail = sh(script: "cd $TEST_DIR && git log -1 --pretty=format:'%ae'", returnStdout: true).trim()

                emailext (
                    to: authorEmail,
                    subject: "ðŸ§ª Jenkins Test Results - ${currentBuild.currentResult}",
                    body: """Hello,

Your latest GitHub push triggered a Jenkins pipeline.

ðŸ”¹ Build Status: ${currentBuild.currentResult}
ðŸ”¹ Job: ${env.JOB_NAME}
ðŸ”¹ Build: ${env.BUILD_NUMBER}
ðŸ”¹ See console: ${env.BUILD_URL}

Regards,  
Jenkins ðŸ¤–""",
                    attachmentsPattern: "$TEST_DIR/test_output.txt"
                )
            }
        }
    }
}
