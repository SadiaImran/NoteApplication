pipeline {
    agent any

    environment {
        REPO_URL = "https://github.com/SadiaImran/NoteApplication.git"
        PROJECT_DIR = "/var/lib/jenkins/NoteApplication"
        TEST_DIR = "NoteAppTests"
    }

    stages {
        stage('Clean workspace') {
            steps {
                sh '''
                rm -rf $PROJECT_DIR
                mkdir -p $PROJECT_DIR
                '''
            }
        }

        stage('Clone Repository') {
            steps {
                sh "git clone $REPO_URL $PROJECT_DIR"
            }
        }

        stage('Build and Run Tests') {
            steps {
                dir("${PROJECT_DIR}/${TEST_DIR}") {
                    sh '''
                    docker build -t noteapp-tests .
                    docker run --rm noteapp-tests > test_output.txt || true
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                def authorEmail = sh(
                    script: "cd $PROJECT_DIR && git log -1 --pretty=format:'%ae'",
                    returnStdout: true
                ).trim()

                emailext (
                    to: authorEmail,
                    subject: "âœ… Jenkins Test Results - ${currentBuild.currentResult}",
                    body: """
Hello ${authorEmail},

Your push to the NoteApplication repository triggered a Jenkins test run.

ðŸ”¹ Status: ${currentBuild.currentResult}  
ðŸ”¹ Job: ${env.JOB_NAME}  
ðŸ”¹ Build: #${env.BUILD_NUMBER}  
ðŸ”¹ View Logs: ${env.BUILD_URL}

Regards,  
Jenkins ðŸ¤–
""",
                    attachmentsPattern: "${PROJECT_DIR}/${TEST_DIR}/test_output.txt"
                )
            }
        }
    }
}

